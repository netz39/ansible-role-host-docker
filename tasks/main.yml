# SPDX-FileCopyrightText: 2020 Stefan Haun <tux@netz39.de>
# SPDX-License-Identifier: MIT
#
# This file is a mash-up of:
#   https://github.com/geerlingguy/ansible-role-docker/blob/master/tasks/docker-compose.yml
#   https://www.digitalocean.com/community/tutorials/how-to-install-docker-compose-on-debian-9
#   and our own stuff â€¦
---
# tasks file for host-docker
- name: Gather package facts
  ansible.builtin.package_facts:
    manager: "auto"

- name: Exit if docker.io is installed
  ansible.builtin.fail:
    msg: "Please remove docker.io (Debian vanilla docker package) first!"
  when: "'docker.io' in ansible_facts.packages"

- name: Exit if target python does not match host ansible
  ansible.builtin.fail:
    msg: >
      "Target machine has python {{ ansible_python_version }},
      but your host still runs ansible {{ ansible_version.full }}.
      Please update to ansible 2.16 or later!"
  when: (ansible_version.full is version('2.16', '<')) and
        (ansible_python_version is version('3.12', '>=')) and
        (docker_apt_key_url is match('https://'))

- name: Determine Trixie-style APT setup
  ansible.builtin.set_fact:
    # Debian Trixie has release number 13.
    trixie_setup: "{{ ansible_distribution == 'Debian' and ansible_distribution_major_version | int >= 13 }}"

- name: Include tasks for setting up APT sources (Trixie)
  ansible.builtin.include_tasks: apt_source_setup_trixie.yml
  when: trixie_setup

- name: Include tasks for setting up APT sources (legacy)
  ansible.builtin.include_tasks: apt_source_setup_legacy.yml
  when: not trixie_setup

- name: Install Docker
  ansible.builtin.package:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - docker-ce
      - docker-compose-plugin
      - python3-docker

- name: Set docker configuration
  ansible.builtin.template:
    src: templates/daemon.json.j2
    dest: /etc/docker/daemon.json
    mode: "0644"
    validate: "dockerd --validate --config-file='%s'"
  notify: Restart docker

- name: Place admin users in docker group
  ansible.builtin.user:
    name: "{{ item.logname }}"
    groups: [docker]
    append: yes
  when: (item.docker is defined) and item.docker
  with_items: "{{ users }}"

- name: Include tasks for image prune
  ansible.builtin.include_tasks: docker_image_prune.yml
